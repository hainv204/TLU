create database QUANLYGIAOHANG
USE QUANLYGIAOHANG
CREATE TABLE KHACHHANG (
    MAKHACHHANG INT PRIMARY KEY,
    TENCONGTY VARCHAR(255),
    TENGIAODICH VARCHAR(255),
    DIACHI VARCHAR(255),
    EMAIL VARCHAR(255),
    DIENTHOAI VARCHAR(20),
    FAX VARCHAR(20)
)
CREATE TABLE NHANVIEN (
    MANHANVIEN INT PRIMARY KEY,
    HO VARCHAR(255),
    TEN VARCHAR(255),
    NGAYSINH DATE,
    NGAYLAMVIEC DATE,
    DIACHI VARCHAR(255),
    DIENTHOAI VARCHAR(20),
    LUONGCOBAN DECIMAL(10, 2),
    PHUCAP DECIMAL(10, 2)
)
CREATE TABLE DONDATHANG (
    SOHOADON INT PRIMARY KEY,
    MAKHACHHANG INT,
    MANHANVIEN INT,
    NGAYDATHANG DATE,
    NGAYGIAOHANG DATE,
    NGAYCHUYENHANG DATE,
    NOIGIAOHANG VARCHAR(255),
    FOREIGN KEY (MAKHACHHANG) REFERENCES KHACHHANG (MAKHACHHANG),
    FOREIGN KEY (MANHANVIEN) REFERENCES NHANVIEN (MANHANVIEN)
)
CREATE TABLE NHACUNGCAP (
    MACONGTY INT PRIMARY KEY,
    TENCONGTY VARCHAR(255),
    TENGIAODICH VARCHAR(255),
    DIACHI VARCHAR(255),
    DIENTHOAI VARCHAR(20),
    FAX VARCHAR(20),
    EMAIL VARCHAR(255)
)
CREATE TABLE LOAIHANG (
    MALOAIHANG INT PRIMARY KEY,
    TENLOAIHANG VARCHAR(255)
)
CREATE TABLE MATHANG (
    MAHANG INT PRIMARY KEY,
    TENHANG VARCHAR(255),
    MACONGTY INT,
    MALOAIHANG INT,
    SOLUONG INT DEFAULT 1,
    DONVITINH VARCHAR(20),
    GIAHANG DECIMAL(10, 2),
    FOREIGN KEY (MACONGTY) REFERENCES NHACUNGCAP (MACONGTY),
    FOREIGN KEY (MALOAIHANG) REFERENCES LOAIHANG (MALOAIHANG)
)
CREATE TABLE CHITIETDATHANG (
    SOHOADON INT,
    MAHANG INT,
    SOLUONG INT DEFAULT 1,
    MUCGIAMGIA DECIMAL(5, 2) DEFAULT 0,
    FOREIGN KEY (SOHOADON) REFERENCES DONDATHANG (SOHOADON),
    FOREIGN KEY (MAHANG) REFERENCES MATHANG (MAHANG)
)

--c)
ALTER TABLE CHITIETDATHANG
add constraint RB_SL default '1' for SOLUONG
ALTER TABLE CHITIETDATHANG
add constraint RB_MGG default '0' for MUCGIAMGIA
--d)
ALTER TABLE DONDATHANG
ADD CONSTRAINT CHECK_GIAOHANG
CHECK (NGAYGIAOHANG >= NGAYDATHANG)
ALTER TABLE DONDATHANG
ADD CONSTRAINT CHECK_CHUYENHANG
CHECK (NGAYCHUYENHANG >= NGAYDATHANG)

--e)
ALTER TABLE NHANVIEN
ADD CONSTRAINT CHECK_TUOI
CHECK (DATEDIFF(NOW(), NGAYSINH) >= 6570 AND DATEDIFF(NOW(), NGAYSINH) <= 21900)

--Chen du lieu 
-- Chèn dữ liệu vào bảng KHACHHANG
INSERT INTO KHACHHANG VALUES
 (1, 'Công ty A', 'Nguyễn Văn AN', 'Địa chỉ A', 'a1@gmail.com', '0123456781', 'FAX123'),
 (2, 'Công ty B', 'Nguyễn Văn Anh', 'Địa chỉ A1', 'a2@gmail.com', '0123456782', 'FAX124'),
 (3, 'Công ty C', 'Nguyễn Văn Duc', 'Địa chỉ A2', 'a3@gmail.com', '0123456783', 'FAX125'),
 (4, 'Công ty D', 'Nguyễn Đức Mạnh', 'Địa chỉ A3', 'a4@gmail.com', '0123456784', 'FAX126'),
 (5, 'Công ty E', 'Nguyễn Dức Minh', 'Địa chỉ A4', 'a5@gmail.com', '0123456785', 'FAX127'),
 (6, 'Công ty F', 'Nguyễn Văn Thức', 'Địa chỉ A5', 'a6@gmail.com', '0123456786', 'FAX128'),
 (7, 'Công ty G', 'Nguyễn Văn Nam', 'Địa chỉ A6', 'a7@gmail.com', '0123456787', 'FAX120'),
 (8, 'Công ty H', 'Nguyễn Văn Thanh', 'Địa chỉ A7', 'a8@gmail.com', '0123456788', 'FAX111'),
 (9, 'Công ty J', 'Nguyễn Văn Long', 'Địa chỉ A8', 'a9@gmail.com', '0123456789', 'FAX112')

 -- Chèn dữ liệu vào bảng NHANVIEN
INSERT INTO NHANVIEN VALUES 
(1, 'Nguyễn', 'Văn A', '1991-01-01', '2023-01-01', 'Địa chỉ NV A', '0987654321', 5000000, 1000000),
(11, 'Nguyễn', 'Văn B', '1990-01-01', '2023-01-01', 'Địa chỉ NV B', '0987654322', 6000000, 1000000),
(12, 'Nguyễn', 'Văn B1', '1990-02-02', '2023-01-01', 'Địa chỉ NV B1', '0987654323', 5500000, 1000000),
(13, 'Nguyễn', 'Văn B2', '1994-02-01', '2023-01-01', 'Địa chỉ NV B2', '0987654324', 7000000, 1000000),
(14, 'Nguyễn', 'Văn B3', '1995-09-07', '2023-01-01', 'Địa chỉ NV B3', '0987654325', 8000000, 1000000),
(15, 'Nguyễn', 'Dức B4', '1996-01-06', '2023-01-01', 'Địa chỉ NV B4', '0987654326', 5000000, 1000000),
(16, 'Nguyễn', 'Văn B5', '1997-01-05', '2023-01-01', 'Địa chỉ NV B5', '0987654327', 5000000, 1000000),
(17, 'Nguyễn', 'Thị B6', '1998-01-04', '2023-01-01', 'Địa chỉ NV B6', '0987654328', 10000000, 1000000),
(18, 'Nguyễn', 'Văn B7', '1991-03-04', '2023-01-01', 'Địa chỉ NV B7', '0987654311', 11000000, 1000000)
-- Chèn dữ liệu vào bảng DONDATHANG
INSERT INTO DONDATHANG VALUES 
(101, 1, 11, '2023-08-01', '2023-08-15', '2023-08-16', 'Nơi giao hàng 1'),
(100, 2, 12, '2023-08-02', '2023-08-15', '2023-08-10', 'Nơi giao hàng 2'),
(102, 3, 13, '2023-07-01', '2023-07-04', '2023-07-02', 'Nơi giao hàng 3'),
(103, 4, 14, '2023-06-17', '2023-06-19', '2023-06-18', 'Nơi giao hàng 4'),
(104, 5, 17 ,'2023-01-01', '2023-01-02', '2023-01-01', 'Nơi giao hàng 1'),
(105, 6, 18, '2023-12-19', '2023-12-22', '2023-12-20', 'Nơi giao hàng 3'),
(106, 7, 16, '2023-01-05', '2023-01-20', '2023-01-15', 'Nơi giao hàng 2')
-- Chèn dữ liệu vào bảng NHACUNGCAP
INSERT INTO NHACUNGCAP VALUES 
(110, 'Công ty D', 'GIAODICH1', 'Địa chỉ A', '0123123121', 'fax1','amailX@gmail.com'),
(111, 'Công ty D1', 'GIAODICH2', 'Địa chỉ A1', '0123123122','fax2', 'bmailX@gmail.com'),
(112, 'Công ty D2', 'GIAODICH3', 'Địa chỉ A2', '0123123123','fax3', 'cmailX@gmail.com'),
(113, 'Công ty D3', 'GIAODICH4', 'Địa chỉ A3', '0123123124', 'fax4','dmailX@gmail.com'),
(114, 'Công ty D4', 'GIAODICH5', 'Địa chỉ A4', '0123123125','fax5', 'emailX@gmail.com'),
(115, 'Công ty D5', 'GIAODICH6', 'Địa chỉ A5', '0123123127', 'fax6','fmailX@gmail.com')
-- Chèn dữ liệu vào bảng LOAIHANG
INSERT INTO LOAIHANG (MALOAIHANG, TENLOAIHANG)
VALUES 
(11, 'Loại 11'),
(22, 'Loại 22'),
(33, 'Loại 33'),
(44, 'Loại 44'),
(55, 'Loại 55'),
(66, 'Loại 66')
-- Chèn dữ liệu vào bảng MATHANG
INSERT INTO MATHANG VALUES
(220, 'Hàng 1', 110, 11, 300, 'Chiếc', 1500000),
(221, 'Hàng 2', 111, 22, 401, 'Chiếc', 2500000),
(222, 'Hàng 3', 112, 33, 302, 'Chiếc',100000),
(223, 'Hàng 4', 113, 44, 500, 'Chiếc', 1200000),
(224, 'Hàng 5', 114, 55, 304, 'Chiếc', 400000),
(225, 'Hàng 6', 115, 66, 1005, 'Chiếc', 300000)
-- Chèn dữ liệu vào bảng CHITIETDATHANG
INSERT INTO CHITIETDATHANG VALUES 
(101, 220, 100, 0),
(102, 221, 500, 0),
(103, 222, 600, 0),
(104, 223, 150, 0),
(105, 224, 1000, 0),
(106, 225, 111, 0)
--Lệnh truy vấn

--1)
SELECT TENCONGTY
FROM NHACUNGCAP;

--2)
SELECT MAHANG, TENHANG, SOLUONG
FROM MATHANG;

--3)
SELECT HO, TEN, DIACHI, NGAYLAMVIEC
FROM NHANVIEN;


--4)
SELECT DIACHI, DIENTHOAI
FROM NHACUNGCAP
WHERE TENGIAODICH = 'VINAMILK';

--5)
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE GIAHANG > 100000 AND SOLUONG < 50;

--6)
SELECT MATHANG.MAHANG, MATHANG.TENHANG, NHACUNGCAP.TENCONGTY
FROM MATHANG
INNER JOIN NHACUNGCAP ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY;

--7)
SELECT MATHANG.MAHANG, MATHANG.TENHANG
FROM MATHANG
WHERE MATHANG.MACONGTY = (SELECT MACONGTY FROM NHACUNGCAP WHERE TENCONGTY = 'Việt Tiến');

--8)
SELECT LOAIHANG.TENLOAIHANG, NHACUNGCAP.TENCONGTY, NHACUNGCAP.DIACHI
FROM LOAIHANG
INNER JOIN MATHANG ON LOAIHANG.MALOAIHANG = MATHANG.MALOAIHANG
INNER JOIN NHACUNGCAP ON MATHANG.MACONGTY = NHACUNGCAP.MACONGTY
WHERE LOAIHANG.TENLOAIHANG = 'Thực phẩm';

--9)
SELECT KHACHHANG.TENGIAODICH
FROM KHACHHANG
INNER JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE MATHANG.TENHANG = 'Sữa hộp XYZ';

--10)
SELECT NHANVIEN.HO, NHANVIEN.TEN AS NV_TEN, KHACHHANG.TENGIAODICH AS KH_TEN, DONDATHANG.NGAYDATHANG, DONDATHANG.NOIGIAOHANG
FROM NHANVIEN
INNER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
INNER JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
WHERE DONDATHANG.SOHOADON = 101;

--11)
SELECT HO, TEN, (LUONGCOBAN + PHUCAP) AS LUONG
FROM NHANVIEN;

--12)
SELECT MATHANG.MAHANG, MATHANG.TENHANG, (SOLUONG * GIAHANG - (SOLUONG * GIAHANG * MUCGIAMGIA / 100)) AS TONGTIEN
FROM CHITIETDATHANG
INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE CHITIETDATHANG.SOHOADON = 103;

--13)
SELECT DISTINCT NHACUNGCAP.TENGIAODICH AS DOITAC
FROM NHACUNGCAP
INNER JOIN KHACHHANG ON NHACUNGCAP.TENGIAODICH = KHACHHANG.TENGIAODICH;

--14)
SELECT A.HO AS NV1_HO, A.TEN AS NV1_TEN, B.HO AS NV2_HO, B.TEN AS NV2_TEN, A.NGAYSINH
FROM NHANVIEN A
INNER JOIN NHANVIEN B ON A.MANHANVIEN <> B.MANHANVIEN AND A.NGAYSINH = B.NGAYSINH;

--15)
SELECT DONDATHANG.SOHOADON, KHACHHANG.TENGIAODICH AS KHACHHANG, DONDATHANG.NGAYGIAOHANG, DONDATHANG.MAKHACHHANG
FROM DONDATHANG
INNER JOIN KHACHHANG ON DONDATHANG.MAKHACHHANG = KHACHHANG.MAKHACHHANG
WHERE DONDATHANG.NOIGIAOHANG = 'Công ty';

--16)
SELECT TENGIAODICH, DIACHI, DIENTHOAI
FROM KHACHHANG
UNION
SELECT TENGIAODICH, DIACHI, DIENTHOAI
FROM NHACUNGCAP;

--17)
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE MAHANG NOT IN (SELECT MAHANG FROM CHITIETDATHANG);

--18)
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE MAHANG NOT IN (SELECT MAHANG FROM CHITIETDATHANG);

--19)
SELECT HO, TEN
FROM NHANVIEN
WHERE LUONGCOBAN = (SELECT MAX(LUONGCOBAN) FROM NHANVIEN);

--20)
SELECT SOHOADON, SUM(SOLUONG * GIAHANG) AS TONGTIEN
FROM CHITIETDATHANG
GROUP BY SOHOADON;

--21)
SELECT MAHANG, TENHANG
FROM MATHANG
WHERE MAHANG IN (SELECT MAHANG FROM CHITIETDATHANG GROUP BY MAHANG HAVING COUNT(SOHOADON) = 1)
AND YEAR(NGAYDATHANG) = 2023;


--22)
SELECT KHACHHANG.TENGIAODICH, SUM(CHITIETDATHANG.SOLUONG * MATHANG.GIAHANG) AS TONGTIEN
FROM KHACHHANG
LEFT JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
LEFT JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
LEFT JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH;

--23)
SELECT NHANVIEN.HO, NHANVIEN.TEN, COUNT(DONDATHANG.SOHOADON) AS SOLUONGDONDATHANG
FROM NHANVIEN
LEFT JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
GROUP BY NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN;

--24)
SELECT YEAR(NGAYDATHANG) AS NAM, MONTH(NGAYDATHANG) AS THANG, SUM(SOLUONG * GIAHANG) AS TONGTIEN
FROM CHITIETDATHANG
GROUP BY YEAR(NGAYDATHANG), MONTH(NGAYDATHANG)
HAVING YEAR(NGAYDATHANG) = 2023;

--25)
SELECT MATHANG.TENHANG, SUM(SOLUONG * (GIAHANG - GIAHANG * MUCGIAMGIA / 100)) AS LOI
FROM CHITIETDATHANG
INNER JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
WHERE YEAR(CHITIETDATHANG.NGAYDATHANG) = 2023
GROUP BY MATHANG.TENHANG;

--26)
SELECT MATHANG.TENHANG, SUM(MATHANG.SOLUONG) AS TONGSOLUONG
FROM MATHANG
GROUP BY MATHANG.TENHANG;

--27)
SELECT TOP 1 NHANVIEN.HO, NHANVIEN.TEN, SUM(CHITIETDATHANG.SOLUONG) AS TONGSOLUONGBAN
FROM NHANVIEN
INNER JOIN DONDATHANG ON NHANVIEN.MANHANVIEN = DONDATHANG.MANHANVIEN
INNER JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
GROUP BY NHANVIEN.MANHANVIEN, NHANVIEN.HO, NHANVIEN.TEN
ORDER BY TONGSOLUONGBAN DESC

--28)
SELECT TOP 1 SOHOADON, MIN(SOLUONG) AS SOLUONGMIN
FROM CHITIETDATHANG
GROUP BY SOHOADON
ORDER BY SOLUONGMIN


--29)
SELECT KHACHHANG.TENGIAODICH, MAX(TONGTIEN) AS SOTIENMAX
FROM (
    SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH, SUM(CHITIETDATHANG.SOLUONG * MATHANG.GIAHANG) AS TONGTIEN
    FROM KHACHHANG
    LEFT JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
    LEFT JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    LEFT JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
    GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH
) AS TONGTIENKHACHHANG
GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH;

--30)
SELECT KHACHHANG.TENGIAODICH, MAX(TONGTIEN) AS SOTIENMAX
FROM (
    SELECT KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH, SUM(CHITIETDATHANG.SOLUONG * MATHANG.GIAHANG) AS TONGTIEN
    FROM KHACHHANG
    LEFT JOIN DONDATHANG ON KHACHHANG.MAKHACHHANG = DONDATHANG.MAKHACHHANG
    LEFT JOIN CHITIETDATHANG ON DONDATHANG.SOHOADON = CHITIETDATHANG.SOHOADON
    LEFT JOIN MATHANG ON CHITIETDATHANG.MAHANG = MATHANG.MAHANG
    GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH
) AS TONGTIENKHACHHANG
GROUP BY KHACHHANG.MAKHACHHANG, KHACHHANG.TENGIAODICH;

--31)
SELECT LOAIHANG.TENLOAIHANG, GROUP_CONCAT(MATHANG.TENHANG) AS DANHSACHMATHANG, SUM(MATHANG.SOLUONG) AS TONGSOLUONGLOAI, (SELECT SUM(SOLUONG) FROM MATHANG) AS TONGSOLUONGTATCA
FROM LOAIHANG
LEFT JOIN MATHANG ON LOAIHANG.MALOAIHANG = MATHANG.MALOAIHANG
GROUP BY LOAIHANG.MALOAIHANG, LOAIHANG.TENLOAIHANG;
